# 文档合并工具（Swing + FlatLaf）

本项目是一个桌面应用，用于扫描指定目录下的 `.docx` / `.doc` / 图片 / PDF 文件并按照列表顺序合并为一个输出 `.docx`。界面、提示与日志全部为简体中文（UTF-8）。

## 主要功能
- 选择输入目录与输出目录（记忆上次选择）。
- 支持从多个目录混合添加文件：
  - “添加文件...”支持多选 `.doc` / `.docx` 并按文件名自然排序后追加。
  - “添加目录...”扫描目录直接子文件并按目录内顺序追加。
  - “选择输入目录/刷新文件列表”作为批量加载快捷入口（按该目录历史顺序加载）。
- 默认排序：文件名前缀数字优先的自然排序；无数字则按不区分大小写的字典序，且排序稳定。
- 列表支持勾选合并（默认全选），提供“全选 / 全不选 / 反选”。
- 支持表格内拖拽调整顺序，顺序立即持久化；每个输入目录都有独立的顺序记录。
- 合并输出为一个 `.docx`，输出文件名可自定义：
  - 允许中文与空格；若未包含 `.docx` 自动补全。
  - 禁止 Windows 非法字符（\ / : * ? " < > |）。
  - 若输出文件已存在，合并前提示覆盖确认。
- 后台任务执行合并，进度提示、可取消。
- 实时中文日志面板，支持清空与复制全部。
- 配置持久化：`~/.doc-merge-app/config.json`，包含：
  - 上次输入/输出目录、输出文件名。
  - 合并列表顺序与勾选状态（含多目录混合）。
  - 每个目录的独立排序偏好（用于目录刷新）。
  - `docConverterMode`：DOC 转换模式（`AUTO` / `WORD_ONLY` / `WPS_ONLY`）。

## 构建与运行（Windows PowerShell）
```powershell
mvn -DskipTests package
java -jar target\doc-merge-app-1.0.0.jar
```

## .doc 完美转换说明（硬性要求）
- `.doc -> .docx` 必须使用 COM 自动化引擎（禁止 LibreOffice、禁止 Apache POI HWPF）。
- 支持三种“DOC 转换引擎”模式（UI 中可选，持久化到配置）：
  1. 自动（Word优先）：优先 Word COM，若不可用再尝试 WPS COM。
  2. 仅 Word：强制使用 Microsoft Word COM，不可用则**硬性失败**。
  3. 仅 WPS：强制使用 WPS 文字 COM，不可用则**硬性失败**。
- 仅支持 Windows 环境，且需要本机已安装 Microsoft Word 或 WPS 文字。
- 程序会在启动时检测可用性（PowerShell + COM 探测），并在界面显示：
  - `Word：可用/不可用`
  - `WPS：可用/不可用`
  - `当前模式：自动（Word优先）/仅 Word/仅 WPS`
- 当当前模式不可用时：
  - 将阻止 `.doc` 文件加入列表；
  - 若列表中仍存在 `.doc`（例如历史配置残留），合并会被硬性阻止，不会生成任何输出文件。
  - 可点击“检测环境”强制重新探测，并在日志中输出探测结果。

### 可用性检测与故障排查
- PowerShell：优先使用 `pwsh`，无则回退到 `powershell`。
- 若提示不可用，请检查：
  1. 是否为 Windows 系统；
  2. 是否已安装 Microsoft Word 或 WPS 文字；
  3. 当前所选模式是否正确（仅 Word / 仅 WPS 会强制失败）；
  4. PowerShell 执行策略是否允许脚本运行（建议临时使用 `-ExecutionPolicy Bypass`，程序内部已设置）。
- 若 Word/WPS 正在被其它实例占用或无响应，可能会导致转换失败，请先关闭可能卡住的 Word/WPS 实例后重试。
- 若出现“COM 探测失败/转换失败”，请优先查看日志中的 stderr 以定位具体原因。
- 路径包含空格或中文无需额外处理，程序会自动进行 PowerShell 转义。

## 使用提示
1. 点击“选择输入目录”，选择包含 `.docx` / `.doc` 的文件夹后可直接“刷新文件列表”。
2. 也可以使用“添加文件...”或“添加目录...”从多个位置混合加入待合并文件。
3. 在表格中拖拽行调整顺序；使用复选框决定是否参与合并。
4. 点击“选择输出目录”，填写或修改“输出文件名”。
5. 点击“开始合并”即可生成合并后的 `.docx`。

## Merge Rules and Format Support
### 支持的文件类型
- Word 文档：`.doc` / `.docx`
- 图片：`.png` / `.jpg` / `.jpeg` / `.bmp` / `.gif`（仅取第一帧）
- PDF：`.pdf`

### 合并规则（按列表顺序 + 勾选结果）
- `.doc`：通过 COM 转换为 `.docx` 后合并（Word 优先，WPS 兜底）。
- `.docx`：保留原内容，按顺序追加到输出文档。
- 图片：
  - 插入标题：`【图片】<文件名>`。
  - 图片嵌入正文（非附件），自动缩放到页面可用宽度，保持比例，居中。
  - 插入后默认分页（page break）。
- PDF：
  - 插入标题：`【PDF】<文件名>`。
  - 逐页渲染为图片后插入正文（默认 DPI=150），每页后分页。
  - 大 PDF 逐页处理，避免一次性加载全部页面。

### 进度计算（工作量单位）
- DOC/DOCX：每个文件 1 单位。
- 图片：每个文件 1 单位。
- PDF：按页数计单位（每页 1 单位）。

## 前端开发技术文档
### 关键类职责
- `MainFrame`：Swing 主界面，包含文件列表操作、合并触发、日志与进度展示、COM 环境探测与状态展示。
- `FileItem`：文件元信息模型，包含路径、状态、类型（DOC/DOCX/图片/PDF）与勾选状态。
- `FileScanner`：扫描目录与过滤文件，支持 doc/docx/pdf/图片的扩展名识别。
- `FileTableModel`：列表表格模型，支持“类型”列与勾选逻辑。
- `MergeService`：合并引擎，负责 DOC 转换、DOCX 合并、图片/ PDF 渲染插入、分页与进度回调。

### 构建与运行
- 构建：`mvn -DskipTests package`
- 运行：`java -jar target\doc-merge-app-1.0.0.jar`

### 性能与稳定性说明
- PDF 渲染采用逐页处理（PDFBox `PDFRenderer`），避免一次性加载所有页面。
- 图片插入按页面可用宽度缩放，保持比例，避免过宽导致版式错乱。
- 合并任务使用 `SwingWorker`，UI 不冻结，支持取消。

### 手工测试用例（至少 8 项）
1. 混合添加 `.docx` + `.doc` + `.pdf` + `.png` 文件，检查合并顺序与输出内容正确。
2. 目录扫描包含图片与 PDF，列表能正确识别类型并显示“类型”列。
3. 拖拽调整顺序后合并，输出顺序与界面一致。
4. 取消勾选部分文件，合并结果应跳过未勾选项。
5. 添加多页 PDF（≥5 页），观察进度条按页推进且日志输出分页进度。
6. 使用中文路径/中文文件名的图片与 PDF，合并应成功且日志正常。
7. 插入超大图片（如 10MB 以上），应自动缩放并居中，输出不变形。
8. 输出文件已存在，验证覆盖确认流程有效，确认后可正常生成。
