# 超级word拼接- 飞天专版（Swing + FlatLaf）

本项目是一个桌面应用，用于扫描指定目录下的 `.docx` / `.doc` / `.pdf` / 图片文件，并按列表顺序合并为一个输出 `.docx`。界面、提示与日志全部为简体中文（UTF-8）。

## 主要功能
- 选择输入目录与输出目录（记忆上次选择）。
- 支持从多个目录混合添加文件：
  - “添加文件...”支持多选 `.doc` / `.docx` / `.pdf` / 图片并按文件名自然排序后追加。
  - “添加目录...”扫描目录直接子文件并按目录内顺序追加。
  - “选择输入目录/扫描”作为批量加载快捷入口（按该目录历史顺序加载）。
- 默认排序：文件名前缀数字优先的自然排序；无数字则按不区分大小写的字典序，且排序稳定。
- 列表支持勾选合并（默认全选），提供“全选 / 全不选 / 反选”。
- 支持表格内拖拽调整顺序，顺序立即持久化；每个输入目录都有独立的顺序记录。
- 合并输出为一个 `.docx`，输出文件名可自定义：
  - 允许中文与空格；若未包含 `.docx` 自动补全。
  - 禁止 Windows 非法字符（\ / : * ? " < > |）。
  - 若输出文件已存在，合并前提示覆盖确认。
- 后台任务执行合并，进度提示、可取消。
- 实时中文日志面板，支持清空与复制全部。
- 预览面板：
  - 图片显示缩略图。
  - 文档（doc/docx/pdf）显示文本内容预览。
  - 预览异步加载，快速切换会取消旧任务。
- 配置持久化：`~/.doc-merge-app/config.json`，包含：
  - 上次输入/输出目录、输出文件名。
  - 合并列表顺序与勾选状态（含多目录混合）。
  - 每个目录的独立排序偏好（用于目录刷新）。
  - `docConverterMode`：转换模式（`AUTO` / `WORD_ONLY` / `WPS_ONLY`）。
  - 窗口大小与左右分栏位置。

## 构建与运行（Windows PowerShell）
```powershell
mvn -DskipTests package
java -jar target\doc-merge-app-1.0.0.jar
```

## DOC/PDF 转换说明（硬性要求）
- `.doc -> .docx` 必须使用 COM 自动化引擎（禁止 LibreOffice、禁止 Apache POI HWPF）。
- `.pdf -> .docx` 必须使用 COM 自动化引擎（优先 Word，WPS 仅作为回退；若 WPS 不支持会明确报错）。
- 支持三种“转换引擎”模式（UI 中可选，持久化到配置）：
  1. 自动（Word优先）：优先 Word COM，若不可用再尝试 WPS COM。
  2. 仅 Word：强制使用 Microsoft Word COM，不可用则**硬性失败**。
  3. 仅 WPS：强制使用 WPS 文字 COM，不可用则**硬性失败**。
- 仅支持 Windows 环境，且需要本机已安装 Microsoft Word 或 WPS 文字。
- 程序会在启动时检测可用性（PowerShell + COM 探测），并在界面显示：
  - `Word：可用/不可用`
  - `WPS：可用/不可用`
  - `当前模式：自动（Word优先）/仅 Word/仅 WPS`
- 当当前模式不可用时：
  - 将阻止 `.doc` 文件加入列表；
  - 若列表中仍存在 `.doc` / `.pdf`（例如历史配置残留），合并会被硬性阻止，不会生成任何输出文件。
  - 可点击“检测环境”强制重新探测，并在日志中输出探测结果。

### 可用性检测与故障排查
- PowerShell：优先使用 `pwsh`，无则回退到 `powershell`。
- 若提示不可用，请检查：
  1. 是否为 Windows 系统；
  2. 是否已安装 Microsoft Word 或 WPS 文字；
  3. 当前所选模式是否正确（仅 Word / 仅 WPS 会强制失败）；
  4. PowerShell 执行策略是否允许脚本运行（建议临时使用 `-ExecutionPolicy Bypass`，程序内部已设置）。
- 若 Word/WPS 正在被其它实例占用或无响应，可能会导致转换失败，请先关闭可能卡住的 Word/WPS 实例后重试。
- 若出现“COM 探测失败/转换失败”，请优先查看日志中的 stderr 以定位具体原因。
- 路径包含空格或中文无需额外处理，程序会自动进行 PowerShell 转义。

## 使用提示
1. 点击“选择目录”，选择包含 `.docx` / `.doc` / `.pdf` / 图片 的文件夹后可直接“扫描”。
2. 也可以使用“添加文件...”或“添加目录...”从多个位置混合加入待合并文件。
3. 在表格中拖拽行调整顺序；使用复选框决定是否参与合并。
4. 点击“选择输出位置”，填写或修改“输出文件名”。
5. 点击“开始合并”即可生成合并后的 `.docx`。

## Merge Rules and Format Support
### 支持的文件类型
- Word 文档：`.doc` / `.docx`
- PDF：`.pdf`
- 图片：`.png` / `.jpg` / `.jpeg` / `.bmp` / `.gif`（仅取第一帧）

### 合并规则（按列表顺序 + 勾选结果）
- `.doc`：通过 COM 转换为 `.docx` 后合并（Word 优先，WPS 兜底）。
- `.docx`：保留原内容，按顺序追加到输出文档。
- `.pdf`：**必须先通过 COM 转换为 `.docx` 再合并**（禁止渲染为图片）。
- 图片：
  - 插入标题：`【图片】<文件名>`。
  - 图片嵌入正文（非附件），自动缩放到页面可用宽度，保持比例，居中。
  - 插入后默认分页（page break）。

### 进度计算（工作量单位）
- DOC/DOCX：每个文件 1 单位。
- PDF：每个文件 1 单位（转换 + 合并）。
- 图片：每个文件 1 单位。

## 预览规则
- 图片：读取首帧生成缩略图，最大边长 480px，居中显示，并显示文件名、分辨率与大小。
- DOC/DOCX：使用 Apache POI 提取文本；`.doc` 会先通过 COM 转成临时 `.docx` 再提取。
- PDF：使用 PDFBox `PDFTextStripper` 提取文本并显示页数。
- 预览内容最多 20,000 字，超出部分会提示截断。
- 预览结果使用 LRU 缓存（最近 50 个）减少重复解析；`.doc` 临时转换结果亦缓存。

## 新 UI 布局说明
- 顶部：配置区（输入目录、输出位置与文件名、转换引擎与环境探测）。
- 中部：左右分栏（左侧文件列表 + 工具栏；右侧预览区域）。
- 底部：日志 + 进度/状态（支持复制与清空日志）。

## 前端开发技术文档
### 关键类职责
- `MainFrame`：Swing 主界面，包含文件列表操作、合并触发、日志与进度展示、COM 环境探测与状态展示、预览区域控制。
- `PreviewService`：预览解析服务，负责图片缩略图、doc/docx/pdf 文本提取与 LRU 缓存。
- `FileItem`：文件元信息模型，包含路径、状态、类型（DOC/DOCX/图片/PDF）与勾选状态。
- `FileScanner`：扫描目录与过滤文件，支持 doc/docx/pdf/图片的扩展名识别。
- `FileTableModel`：列表表格模型，支持“类型”列与勾选逻辑。
- `MergeService`：合并引擎，负责 DOC/PDF 转换、DOCX 合并、图片插入、分页与进度回调。

### 构建与运行
- 构建：`mvn -DskipTests package`
- 运行：`java -jar target\doc-merge-app-1.0.0.jar`

### 性能与稳定性说明
- DOC/PDF 转换由 COM 自动化完成，后台执行，不阻塞 UI。
- 预览加载由 SwingWorker 异步执行，快速切换会取消旧任务。
- 图片插入按页面可用宽度缩放，保持比例，避免过宽导致版式错乱。

### 手工测试用例（至少 10 项）
1. 混合添加 `.doc` + `.docx` + `.pdf` + `.png` 文件，检查合并顺序与输出内容正确。
2. 大型多页 PDF 通过 Word 转 DOCX，观察日志显示转换过程且最终合并成功。
3. 仅 PDF 文件合并，输出 DOCX 内容完整。
4. 仅图片文件合并，图片按顺序插入且分页正常。
5. 中文/特殊字符路径（如【】、空格、括号）下的文件合并成功。
6. 取消勾选部分文件，合并结果应跳过未勾选项。
7. 拖拽调整顺序后合并，输出顺序与界面一致。
8. 预览区在切换不同文件时不冻结，缩略图与文本能及时更新。
9. 快速连续点击多行，确认预览任务取消正确且最终显示最新选择。
10. Word 不可用时自动回退 WPS；若 WPS 不支持 PDF 转 DOCX，弹出明确错误提示。
